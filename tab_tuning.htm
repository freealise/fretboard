<!DOCTYPE html>
<html>
<head>
<title>Display guitar tabs in simple tuning</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
@font-face {
  font-family: "DejaVu";
  src: url("/vocalise/fonts/dejavu/DejaVuSansMono.ttf") format("truetype");
}
@font-face {
  font-family: "DejaVuBold";
  src: url("/vocalise/fonts/dejavu/DejaVuSansMono-Bold.ttf") format("truetype");
}
body {
  margin:0;
  overflow-x:hidden;
  background-color:#000000;
}
* {
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  font-family: 'DejaVu', monospace;
  line-height:1em;
  color:#ffffff;
}
input, textarea {
  background-color:#000000;
}
#tab {
  letter-spacing: 0px;
  white-space: nowrap;
}
#tab, #out, #hl, #fretless {
  margin:0;
  width:99%;
  height:128px;
  overflow:scroll;
  font-size:16px;
  user-select:none;
  clear: both;
}
#hl a, #fretless a {
  color:transparent;
  border-left:1px solid gray;
  display: inline-block;
  width:0;
}
#hl {
  position:absolute;
  left:-1.2em;
  bottom:0;
}
#toolbar {
  font-size:16px;
  height:1.5em;
}
#position {
  font-weight:bold;
  background-color:black;
}
#chord {
  font-weight:bold;
}
#fretless {
  display:none;
  height:225px;
  font-size:16px;
  position:absolute;
  left:-1.2em;
  bottom: 0;
}
.h {
  font-weight: bold;
  background-color:gray;
}
.note {
  display: inline-block;
  position: relative;
  top:3.2px;
}
.piano {
  width:0;
}
sub {
  line-height:0;
  letter-spacing:-1em;
}
sup {
  font-size:inherit;
  position:relative;
  bottom:3.2px;
  vertical-align:middle;
  line-height:0;
}
</style>
</head>
<body oncontextmenu="return false;">
<a id="printLink" href="#" onclick="if(printMode===false){printMode=true;}else{printMode=false;}printTab();">Save</a><span id="toolbar"> | <a href="#" onclick="copyMap();">Copy map</a> | <a href="#" onclick="if(piano===false){piano=true;}else{piano=false;}">Notation</a> | <a href="#" onclick="showTab();">Show tab</a> | Strings: <a href="#" onclick="switchFretboard(true);">6</a> <a href="#" onclick="switchFretboard(false);">12</a></span> <select id="position" onchange="copyMap();"></select> <span id="chord"></span>
<textarea id="tab" onchange="changeTuning();" onkeypress="editTab(event);">
  
e|-------------------------------|-------------------------------|
B|-------------------------------|-------------------------------|
G|----4---464---4-----4---464---4|--------------------6---686---6|
D|--6---6-----6-----6---6-----6--|----4---464---4---8---8-----8--|
A|6---------------7--------------|--6---6-----6---9--------------|
E|-------------------------------|7------------------------------|

e|-------------------------------|-------------------------------|
B|-------------------------------|-------------------------------|
G|----4---464---4-----4---464---4|--------------------6---686---6|
D|--6---6-----6-----6---6-----6--|----4---464---4---8---8-----8--|
A|6---------------7--------------|--6---6-----6---9--------------|
E|-------------------------------|7------------------------------|

</textarea>
<pre id="out" onclick='clearHl();'></pre>
<pre id="hl"></pre>
<pre id="fretless"></pre>

<script>
var audioCtx = null;
var oscillator = [];
var gainNode = [];

var freq = [329.6276, 246.9417, 195.9977, 146.8324, 110.0000, 82.40689];

function setup() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)({latencyHint:"interactive",sampleRate: 8000});
  for (var i=0; i<6; i++) {
    oscillator[i] = audioCtx.createOscillator();
    gainNode[i] = audioCtx.createGain();
    gainNode[i].gain.setValueAtTime(0, audioCtx.currentTime);
    oscillator[i].type = 'sine';
    oscillator[i].frequency.setValueAtTime(110, audioCtx.currentTime); // value in hertz
    oscillator[i].connect(gainNode[i]);
    gainNode[i].connect(audioCtx.destination);
    oscillator[i].start();
  }
}

function play(t) {
  if (!audioCtx) {
    setup();
  }
  var t_ = parseBinary(t);
  var s = t_[0];
  var f = t_[1];
  oscillator[s].frequency.setValueAtTime(freq[s]*Math.pow(Math.pow(2,1/12), f), audioCtx.currentTime);
  gainNode[s].gain.setValueAtTime(0.25, audioCtx.currentTime+0.001);
}

function stop(t) {
  var t_ = parseBinary(t);
  var s = t_[0];
  gainNode[s].gain.setValueAtTime(0, audioCtx.currentTime+0.001);
}

function stopAll() {
  for (var i=0; i<6; i++) {
    gainNode[i].gain.setValueAtTime(0, audioCtx.currentTime+0.001);
  }
}

var tone = ("꜍꜎꜏꜐꜑").split("");
var barre = ("꜒꜓꜔꜕꜖˥˦˧˨˩").split("");

var octave = [ '꜌', '꜋', '꜊', '꜉', '꜈', 'ᣟ𝍩', '꜑', '꜐', '꜏', '꜎', '꜍', '𝍩ᣟ' ]; //ᐧ
var octave_ = new RegExp("("+octave.join("|")+")", 'g');

var chart = [ '˩', '˨', '˧', '˦', '˥', '꜖', '꜕', '꜔', '꜓', '꜒' ];

var tuning = (
"5 ꜐ c   ꜐ c# ꜐ d  ꜐ d# ꜏ e  ꜏ f  ꜏ f# ꜏ g  ꜏ g# ꜏ a  ꜏ a# ꜏ b  ꜏ c  |\n" +
"4 ꜐ g#  ꜐ a  ꜐ a# ꜐ b  ꜐ c  ꜐ c# ꜐ d  ꜐ d# ꜏ e  ꜏ f  ꜏ f# ꜏ g  ꜏ g# |\n" +
"3 ꜐ e   ꜐ f  ꜐ f# ꜐ g  ꜐ g# ꜐ a  ꜐ a# ꜐ b  ꜐ c  ꜐ c# ꜐ d  ꜐ d# ꜏ e  |\n" +
"2 ꜑ C   ꜑ C# ꜑ D  ꜑ D# ꜐ e  ꜐ f  ꜐ f# ꜐ g  ꜐ g# ꜐ a  ꜐ a# ꜐ b  ꜐ c  |\n" +
"1 ꜑ G#  ꜑ A  ꜑ A# ꜑ B  ꜑ C  ꜑ C# ꜑ D  ꜑ D# ꜐ e  ꜐ f  ꜐ f# ꜐ g  ꜐ g# |\n" +
"0 ꜑ E   ꜑ F  ꜑ F# ꜑ G  ꜑ G# ꜑ A  ꜑ A# ꜑ B  ꜑ C  ꜑ C# ꜑ D  ꜑ D# ꜐ e  |\n"
).replace(octave_, function(x) {return "<a>"+x+"</a>";} );

var notes = ("꜑ C ,꜑ C#,꜑ D ,꜑ D#,꜐ E ,꜐ F ,꜐ F#,꜐ G ,꜐ G#,꜐ A ,꜐ A#,꜐ B ,꜐ c ,꜐ c#,꜐ d ,꜐ d#,꜏ e ,꜏ f ,꜏ f#,꜏ g ,꜏ g#,꜏ a ,꜏ a#,꜏ b ").split(",");
var _tuning = "";
var strings = 12;
var fb = 12;
for (var i=strings-1; i>=0; i--) {
  _tuning += "<span id='f" + i + "'>";
  for (var j=0; j<fb; j++) {
    _tuning += " " + notes[i+j].replace(octave_, function(x){return "<a>"+x+"</a>";});
  }
  _tuning += " |</span>\n";
}

var map = [
['꜏ E', '꜏ F', '꜏ F#', '꜏ G', '꜏ G#', '꜏ A', '꜏ A#', '꜏ B', '꜏ C', '꜏ C#', '꜏ D', '꜏ D#', '꜎ E', '꜎ F', '꜎ F#', '꜎ G', '꜎ G#', '꜎ A', '꜎ A#', '꜎ B', '꜎ C', '꜎ C#', '꜎ D', '꜎ D#', '꜍ E'],
['꜐ B', '꜐ C', '꜐ C#', '꜐ D', '꜐ D#', '꜏ E', '꜏ F', '꜏ F#', '꜏ G', '꜏ G#', '꜏ A', '꜏ A#', '꜏ B', '꜏ C', '꜏ C#', '꜏ D', '꜏ D#', '꜎ E', '꜎ F', '꜎ F#', '꜎ G', '꜎ G#', '꜎ A', '꜎ A#', '꜎ B'],
['꜐ G', '꜐ G#', '꜐ A', '꜐ A#', '꜐ B', '꜐ C', '꜐ C#', '꜐ D', '꜐ D#', '꜏ E', '꜏ F', '꜏ F#', '꜏ G', '꜏ G#', '꜏ A', '꜏ A#', '꜏ B', '꜏ C', '꜏ C#', '꜏ D', '꜏ D#', '꜎ E', '꜎ F', '꜎ F#', '꜎ G'],
['꜑ D', '꜑ D#', '꜐ E', '꜐ F', '꜐ F#', '꜐ G', '꜐ G#', '꜐ A', '꜐ A#', '꜐ B', '꜐ C', '꜐ C#', '꜐ D', '꜐ D#', '꜏ E', '꜏ F', '꜏ F#', '꜏ G', '꜏ G#', '꜏ A', '꜏ A#', '꜏ B', '꜏ C', '꜏ C#', '꜏ D'],
['꜑ A', '꜑ A#', '꜑ B', '꜑ C', '꜑ C#', '꜑ D', '꜑ D#', '꜐ E', '꜐ F', '꜐ F#', '꜐ G', '꜐ G#', '꜐ A', '꜐ A#', '꜐ B', '꜐ C', '꜐ C#', '꜐ D', '꜐ D#', '꜏ E', '꜏ F', '꜏ F#', '꜏ G', '꜏ G#', '꜏ A'],
['꜑ E', '꜑ F', '꜑ F#', '꜑ G', '꜑ G#', '꜑ A', '꜑ A#', '꜑ B', '꜑ C', '꜑ C#', '꜑ D', '꜑ D#', '꜐ E', '꜐ F', '꜐ F#', '꜐ G', '꜐ G#', '꜐ A', '꜐ A#', '꜐ B', '꜐ C', '꜐ C#', '꜐ D', '꜐ D#', '꜏ E'],
];

var chord = document.getElementById("chord");
var position = document.getElementById("position");
var printLink = document.getElementById("printLink");
var toolbar = document.getElementById("toolbar");
var tab = document.getElementById("tab");
var out = document.getElementById("out");
var hl = document.getElementById("hl");
var fretless = document.getElementById("fretless");
var piano = false;
var printMode = false;

for (var i=0; i<25; i++) {
  position.innerHTML += "<option>" + barre[parseInt(i/5)] + " " + barre[5+i-parseInt(i/5)*5] + "</option>";
}

function changeTuning() {
  tab.value = tab.value.replace(/-/g, "—");
  var old = tab.value.trim().split("\n\n");
  var n = [];
  var o = "";
  for (var i=0; i<old.length; i++) {
  	n[i] = old[i].split("|\n");
    for (var j=0; j<6; j++) {
      for (var k=map[0].length-1; k>=0; k--) {
        var k_ = k;
        if (k>=10) {var s = "—";} else {var s = "";}
        var id_ = (j.toString(2)+","+k.toString(2)).replace(/0/g, "o").replace(/1/g, "l");
        var r = new RegExp(k_, 'g');
        if (piano === false) {
          if (map[j][k].length > 3) {
            var note = "<i>" + map[j][k].slice(2,3) + "</i>";
          } else {
            var note = "<b>" + map[j][k].slice(2,3) + "</b>";
          }
    	    n[i][j] = n[i][j].replace(r, s+"<span class='note' onfocus='highlight(this.title);play(this.id);' onmouseover='highlight(this.title);play(this.id);' ontouchstart='highlight(this.title);play(this.id);' onblur='stop(this.id);' onmouseout='stop(this.id);' ontouchend='stop(this.id);' ontouchcancel='stop(this.id);' id='"+id_+"' title='"+map[j][k]+"'>"+note.toLowerCase()+"</span>");
        } else {
          if (j>1) {
            var _k = k+1;
          } else {
            var _k = k;
            if (j==0) {
              n[i][j] = "f" + n[i][j].slice(1);
            } else if (j==1) {
              n[i][j] = "c" + n[i][j].slice(1);
            }
          }
          var fret = "━";
          for (var p=0; p<_k; p++) {
            fret = "<sup>"+fret+"</sup>";
          }
          s += "—";
          n[i][j] = n[i][j].replace(r, "<span class='note piano' onfocus='highlight(this.title);play(this.id);' onmouseover='highlight(this.title);play(this.id);' ontouchstart='highlight(this.title);play(this.id);' onblur='stop(this.id);' onmouseout='stop(this.id);' ontouchend='stop(this.id);' ontouchcancel='stop(this.id);' id='"+id_+"' title='"+map[j][k]+"'>"+fret+"</span>"+s);
        }
      }
    }
    o += n[i].join("|\n")+"\n\n";
  }
  out.innerHTML = o;
}

function parseBinary(t) {
  var t_ = t.split(",");
  t_[0] = parseInt(t_[0].replace(/o/g, "0").replace(/l/g, "1"), 2);
  t_[1] = parseInt(t_[1].replace(/o/g, "0").replace(/l/g, "1"), 2);
  return t_;
}

function highlight(t) {
  if (hl.style.display != "none") {
    var el = hl;
  } else {
    var el = fretless;
  }
  var r = new RegExp('<a>'+t.slice(0,1)+'</a>'+t.slice(1)+' +', 'gi');
  el.innerHTML = el.innerHTML.replace(r, function(x){return "<span class='h'>"+x.toLowerCase().replace(/ /g, "_")+"</span>";});
}

function clearHl() {
  hl.innerHTML = tuning.toLowerCase().replace(/\d/g, function(x){return "<span id='g"+x+"'>";}).replace(/\n/g, "</span>\n");
  fretless.innerHTML = _tuning.toLowerCase();
}
clearHl();

function switchFretboard(d) {
  if (d === true) {
    fretless.style.display = "none";
    hl.style.display = "block";
    tab.style.display = "block";
  } else if (d === false) {
    fretless.style.display = "block";
    hl.style.display = "none";
    tab.style.display = "none";
  } else {
    fretless.style.display = "none";
    hl.style.display = "none";
    tab.style.display = "none";
  }
}

function showTab() {
  if (tab.style.display == "none") {
    tab.style.display = "block";
  } else {
    tab.style.display = "none";
  }
}

function printTab() {
  if (printMode === true) {
    toolbar.style.display = "none";
    out.style.overflow = "visible";
    switchFretboard(null);
    printLink.innerText = "[x]";
    window.print();
  } else {
    toolbar.style.display = "inline-block";
    out.style.overflow = "scroll";
    switchFretboard(true);
    printLink.innerText = "Save or print";
  }
}

function copyMap() {
  if (hl.style.display != "none") {
    var el = hl;
  } else {
    var el = fretless;
  }
  var cb = el.innerText.replace(octave_, "").replace(/\|/g, "").replace(/_[abcdefg]/g, "__").replace(/[#_]_/g, "__").replace(/[abcdefg# ]/g, " ");
  if (el == hl) {
    cb = cb.slice(2,-1).replace(/\n../g, "\n").replace(/____/g, "0").replace(/    /g, "-");
  } else {
    cb = cb.slice(1,-1).replace(/\n./g, "\n").replace(/____/g, "0").replace(/    /g, "-");
  }
  navigator.clipboard.writeText(cb);
  var cb = cb.split("\n");
  var chord_ = [];
  var p = position.options.selectedIndex;
  for (var i=0; i<cb.length; i++) {
    chord_[i] = "꜒";
    for (var j=0; j<cb[i].length; j++) {
      if (cb[i].charAt(j) == "0" && tone[j-p]) {
        chord_[i] = tone[j-p];
        break;
      }
    }
  }
  chord.innerText = chord_.reverse().join("");
}

function editTab(e) {
  if (e.key.length == 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
    e.preventDefault();
    var b = tab.selectionStart;
    var d = tab.selectionEnd;
    tab.value = tab.value.substr(0,b) + e.key + tab.value.substr(d+1);
    tab.setSelectionRange(b+1, d+1);
  }
}

</script>
</body>
</html>
