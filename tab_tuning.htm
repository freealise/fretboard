<!DOCTYPE html>
<html>
<head>
<title>Display guitar tabs in simple tuning</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/firacode@6.2.0/distr/fira_code.css">
<style>
@font-face {
  font-family: "DejaVu";
  src: url("../phonetic/fonts/dejavu/DejaVuSansMono.ttf") format("truetype");
}
@font-face {
  font-family: "DejaVuBold";
  src: url("../phonetic/fonts/dejavu/DejaVuSansMono-Bold.ttf") format("truetype");
}
body {
  margin:0;
  overflow-x:hidden;
  background-color:#000000;
}
* {
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  font-family: 'Fira Code', monospace;
  font-feature-settings: "onum", "ss01", "cv01", "cv02";
  line-height:1em;
  color:#ffffff;
}
input, textarea {
  background-color:#000000;
}
#tab {
  letter-spacing: 0px;
  white-space: nowrap;
}
#tab, #out, #hl, #fretless {
  margin:0;
  width:99%;
  height:128px;
  overflow:scroll;
  font-size:16px;
  user-select:none;
  clear: both;
}
#hl {
  position:absolute;
  left:0;
  bottom:0;
}
#toolbar {
  font-size:16px;
  height:1.5em;
}
#fretless {
  display:none;
  height:225px;
  font-size:16px;
  position:absolute;
  left: 0;
  bottom: 0;
}
.h {
  background-color:darkgray;
}
.note {
  display: inline-block;
  position: relative;
  top:3.2px;
}
sub {
  line-height:0;
  letter-spacing:-1em;
}
sup {
  font-size:inherit;
  position:relative;
  bottom:3.2px;
  vertical-align:middle;
  line-height:0;
}
</style>
</head>
<body oncontextmenu="return false;">
<a id="printLink" href="#" onclick="if(printMode===false){printMode=true;}else{printMode=false;}printTab();">Save or print</a><span id="toolbar"> | <a href="#" onclick="copyMap();">Copy map</a> | <a href="#" onclick="showTab();">Show tab</a> | <a href="#" onclick="if(piano===false){piano=true;}else{piano=false;}">Piano roll</a> | Strings: <a href="#" onclick="switchFretboard(true);">6</a> <a href="#" onclick="switchFretboard(false);">12</a></span>
<textarea id="tab" onchange="changeTuning();" onkeypress="editTab(event);">
  
e|-------------------------------|-------------------------------|
B|-------------------------------|-------------------------------|
G|----4---464---4-----4---464---4|--------------------6---686---6|
D|--6---6-----6-----6---6-----6--|----4---464---4---8---8-----8--|
A|6---------------7--------------|--6---6-----6---9--------------|
E|-------------------------------|7------------------------------|

e|-------------------------------|-------------------------------|
B|-------------------------------|-------------------------------|
G|----4---464---4-----4---464---4|--------------------6---686---6|
D|--6---6-----6-----6---6-----6--|----4---464---4---8---8-----8--|
A|6---------------7--------------|--6---6-----6---9--------------|
E|-------------------------------|7------------------------------|

</textarea>
<pre id="out" onclick='clearHl();'></pre>
<pre id="hl"></pre>
<pre id="fretless"></pre>

<script>
var audioCtx = null;
var oscillator = [];
var gainNode = [];

var freq = [329.6276, 246.9417, 195.9977, 146.8324, 110.0000, 82.40689];

function setup() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)({latencyHint:"interactive",sampleRate: 8000});
  for (var i=0; i<6; i++) {
    oscillator[i] = audioCtx.createOscillator();
    gainNode[i] = audioCtx.createGain();
    gainNode[i].gain.setValueAtTime(0, audioCtx.currentTime);
    oscillator[i].type = 'sine';
    oscillator[i].frequency.setValueAtTime(110, audioCtx.currentTime); // value in hertz
    oscillator[i].connect(gainNode[i]);
    gainNode[i].connect(audioCtx.destination);
    oscillator[i].start();
  }
}

function play(t) {
  if (!audioCtx) {
    setup();
  }
  var t_ = parseBinary(t);
  var s = t_[0];
  var f = t_[1];
  oscillator[s].frequency.setValueAtTime(freq[s]*Math.pow(Math.pow(2,1/12), f), audioCtx.currentTime);
  gainNode[s].gain.setValueAtTime(0.25, audioCtx.currentTime+0.001);
}

function stop(t) {
  var t_ = parseBinary(t);
  var s = t_[0];
  gainNode[s].gain.setValueAtTime(0, audioCtx.currentTime+0.001);
}

function stopAll() {
  for (var i=0; i<6; i++) {
    gainNode[i].gain.setValueAtTime(0, audioCtx.currentTime+0.001);
  }
}

var octave = [ 'êœŒ', 'êœ‹', 'êœŠ', 'êœ‰', 'êœˆ', 'á£Ÿğ©', 'êœ‘', 'êœ', 'êœ', 'êœ', 'êœ', 'ğ©á£Ÿ' ]; //á§ êœ‘êœêœêœêœ

var tuning =
"5 êœ c  |êœ c# êœ d  êœ d# êœ e  êœ f  êœ f# êœ g  êœ g# êœ a  êœ a# êœ b  êœ c  |\n" +
"4 êœ g# |êœ a  êœ a# êœ b  êœ c  êœ c# êœ d  êœ d# êœ e  êœ f  êœ f# êœ g  êœ g# |\n" +
"3 êœ e  |êœ f  êœ f# êœ g  êœ g# êœ a  êœ a# êœ b  êœ c  êœ c# êœ d  êœ d# êœ e  |\n" +
"2 êœ‘ C  |êœ‘ C# êœ‘ D  êœ‘ D# êœ e  êœ f  êœ f# êœ g  êœ g# êœ a  êœ a# êœ b  êœ c  |\n" +
"1 êœ‘ G# |êœ‘ A  êœ‘ A# êœ‘ B  êœ‘ C  êœ‘ C# êœ‘ D  êœ‘ D# êœ e  êœ f  êœ f# êœ g  êœ g# |\n" +
"0 êœ‘ E  |êœ‘ F  êœ‘ F# êœ‘ G  êœ‘ G# êœ‘ A  êœ‘ A# êœ‘ B  êœ‘ C  êœ‘ C# êœ‘ D  êœ‘ D# êœ e  |\n";

var notes = ("êœ‘ C ,êœ‘ C#,êœ‘ D ,êœ‘ D#,êœ E ,êœ F ,êœ F#,êœ G ,êœ G#,êœ A ,êœ A#,êœ B ,êœ c ,êœ c#,êœ d ,êœ d#,êœ e ,êœ f ,êœ f#,êœ g ,êœ g#,êœ a ,êœ a#,êœ b ").split(",");
var _tuning = "";
var strings = 12;
var fb = 12;
for (var i=strings-1; i>=0; i--) {
  _tuning += "<span id='f" + i + "'>";
  for (var j=0; j<fb; j++) {
    _tuning += " " + notes[i+j];
  }
  _tuning += " |</span>\n";
}

var map = [
['êœ E', 'êœ F', 'êœ F#', 'êœ G', 'êœ G#', 'êœ A', 'êœ A#', 'êœ B', 'êœ C', 'êœ C#', 'êœ D', 'êœ D#', 'êœ E', 'êœ F', 'êœ F#', 'êœ G', 'êœ G#', 'êœ A', 'êœ A#', 'êœ B', 'êœ C', 'êœ C#', 'êœ D', 'êœ D#', 'êœ E'],
['êœ B', 'êœ C', 'êœ C#', 'êœ D', 'êœ D#', 'êœ E', 'êœ F', 'êœ F#', 'êœ G', 'êœ G#', 'êœ A', 'êœ A#', 'êœ B', 'êœ C', 'êœ C#', 'êœ D', 'êœ D#', 'êœ E', 'êœ F', 'êœ F#', 'êœ G', 'êœ G#', 'êœ A', 'êœ A#', 'êœ B'],
['êœ G', 'êœ G#', 'êœ A', 'êœ A#', 'êœ B', 'êœ C', 'êœ C#', 'êœ D', 'êœ D#', 'êœ E', 'êœ F', 'êœ F#', 'êœ G', 'êœ G#', 'êœ A', 'êœ A#', 'êœ B', 'êœ C', 'êœ C#', 'êœ D', 'êœ D#', 'êœ E', 'êœ F', 'êœ F#', 'êœ G'],
['êœ‘ D', 'êœ‘ D#', 'êœ E', 'êœ F', 'êœ F#', 'êœ G', 'êœ G#', 'êœ A', 'êœ A#', 'êœ B', 'êœ C', 'êœ C#', 'êœ D', 'êœ D#', 'êœ E', 'êœ F', 'êœ F#', 'êœ G', 'êœ G#', 'êœ A', 'êœ A#', 'êœ B', 'êœ C', 'êœ C#', 'êœ D'],
['êœ‘ A', 'êœ‘ A#', 'êœ‘ B', 'êœ‘ C', 'êœ‘ C#', 'êœ‘ D', 'êœ‘ D#', 'êœ E', 'êœ F', 'êœ F#', 'êœ G', 'êœ G#', 'êœ A', 'êœ A#', 'êœ B', 'êœ C', 'êœ C#', 'êœ D', 'êœ D#', 'êœ E', 'êœ F', 'êœ F#', 'êœ G', 'êœ G#', 'êœ A'],
['êœ‘ E', 'êœ‘ F', 'êœ‘ F#', 'êœ‘ G', 'êœ‘ G#', 'êœ‘ A', 'êœ‘ A#', 'êœ‘ B', 'êœ‘ C', 'êœ‘ C#', 'êœ‘ D', 'êœ‘ D#', 'êœ E', 'êœ F', 'êœ F#', 'êœ G', 'êœ G#', 'êœ A', 'êœ A#', 'êœ B', 'êœ C', 'êœ C#', 'êœ D', 'êœ D#', 'êœ E'],
];

var printLink = document.getElementById("printLink");
var toolbar = document.getElementById("toolbar");
var tab = document.getElementById("tab");
var out = document.getElementById("out");
var hl = document.getElementById("hl");
var fretless = document.getElementById("fretless");
var piano = false;
var printMode = false;

function changeTuning() {
  var old = tab.value.trim().split("\n\n");
  var n = [];
  var o = "";
  for (var i=0; i<old.length; i++) {
  	n[i] = old[i].split("|\n");
    for (var j=0; j<6; j++) {
      for (var k=map[0].length-1; k>=0; k--) {
        var k_ = k;
        if (k>=10) {var s = "-";} else {var s = "";}
        var id_ = (j.toString(2)+","+k.toString(2)).replace(/0/g, "o").replace(/1/g, "l");
        var r = new RegExp(k_, 'g');
        if (piano === false) {
          if (map[j][k].length > 3) {
            var note = "<i>" + map[j][k].slice(2,3) + "</i>";
          } else {
            var note = "<b>" + map[j][k].slice(2,3) + "</b>";
          }
    	    n[i][j] = n[i][j].replace(r, s+"<span class='note' onfocus='highlight(this.title);play(this.id);' onmouseover='highlight(this.title);play(this.id);' ontouchstart='highlight(this.title);play(this.id);' onblur='stop(this.id);' onmouseout='stop(this.id);' ontouchend='stop(this.id);' ontouchcancel='stop(this.id);' id='"+id_+"' title='"+map[j][k]+"'>"+note.toLowerCase()+"</span>");
        } else {
          if (j>1) {
            var _k = k+1;
          } else {
            var _k = k;
            if (j==0) {
              n[i][j] = "f" + n[i][j].slice(1);
            } else if (j==1) {
              n[i][j] = "c" + n[i][j].slice(1);
            }
          }
          var fret = "â”";
          for (var p=0; p<_k; p++) {
            fret = "<sup>"+fret+"</sup>";
          }
          n[i][j] = n[i][j].replace(r, s+"<span class='note' onfocus='highlight(this.title);play(this.id);' onmouseover='highlight(this.title);play(this.id);' ontouchstart='highlight(this.title);play(this.id);' onblur='stop(this.id);' onmouseout='stop(this.id);' ontouchend='stop(this.id);' ontouchcancel='stop(this.id);' id='"+id_+"' title='"+map[j][k]+"'>"+fret+"</span>");
        }
      }
    }
    o += n[i].join("|\n")+"\n\n";
  }
  out.innerHTML = o;
}

function parseBinary(t) {
  var t_ = t.split(",");
  t_[0] = parseInt(t_[0].replace(/o/g, "0").replace(/l/g, "1"), 2);
  t_[1] = parseInt(t_[1].replace(/o/g, "0").replace(/l/g, "1"), 2);
  return t_;
}

function highlight(t) {
  if (hl.style.display != "none") {
    var el = hl;
  } else {
    var el = fretless;
  }
  var r = new RegExp(t+' +', 'gi');
  el.innerHTML = el.innerHTML.replace(r, function(x){return "<span class='h'>"+x.toLowerCase().replace(/ /g, "_")+"</span>";});
}

function clearHl() {
  hl.innerHTML = tuning.toLowerCase().replace(/\d/g, function(x){return "<span id='g"+x+"'>";}).replace(/\n/g, "</span>\n");
  fretless.innerHTML = _tuning.toLowerCase();
}
clearHl();

function switchFretboard(d) {
  if (d === true) {
    fretless.style.display = "none";
    hl.style.display = "block";
    tab.style.display = "block";
  } else if (d === false) {
    fretless.style.display = "block";
    hl.style.display = "none";
    tab.style.display = "none";
  } else {
    fretless.style.display = "none";
    hl.style.display = "none";
    tab.style.display = "none";
  }
}

function showTab() {
  if (tab.style.display == "none") {
    tab.style.display = "block";
  } else {
    tab.style.display = "none";
  }
}

function printTab() {
  if (printMode === true) {
    toolbar.style.display = "none";
    out.style.overflow = "visible";
    switchFretboard(null);
    printLink.innerText = "[x]";
    window.print();
  } else {
    toolbar.style.display = "inline-block";
    out.style.overflow = "scroll";
    switchFretboard(true);
    printLink.innerText = "Save or print";
  }
}

function copyMap() {
  if (hl.style.display != "none") {
    var el = hl;
  } else {
    var el = fretless;
  }
  navigator.clipboard.writeText(el.innerText.replace(/\ [abcdefg]/g, "  "));
}

function editTab(e) {
  if (e.key.length == 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
    e.preventDefault();
    var b = tab.selectionStart;
    var d = tab.selectionEnd;
    tab.value = tab.value.substr(0,b) + e.key + tab.value.substr(d+1);
    tab.setSelectionRange(b+1, d+1);
  }
}

</script>
</body>
</html>
